<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <style>
            .map {
                width: 600px;
                height: 500px;
            }
            .map-box {
                display: flex;
            }
            .search-input-box {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
            }
            .input-label {
                width: 60px;
            }
            .address_box {
                width : 500px;
                height : 25px;
            }
            .marker-infowindow {
                font-size: 12px;
                width: 150px;
                text-align: center;
                padding-top: 5px;
            }
        </style>
    </head>
    <body>
        <div class="search-input-box">
            <div class="input-label">주소</div>
            <input type="text" class="address_box" id="address-region" />
        </div>
        <div class="search-input-box">
            <div class="input-label">키워드</div>
            <input type="text" class="address_box" id="address-keyword" />
        </div>
        <div class="map-box">
            <div class="map" id="map">
            </div>
            <div class="info-box">
                
            </div>
        </div>

        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f981fd80b1fe939a8deee13f73970262&libraries=services"></script>
        <script>
            const container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
            const options = { //지도를 생성할 때 필요한 기본 옵션
                center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
                level: 3 //지도의 레벨(확대, 축소 정도)
            };

            const map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

            const geocoder = new kakao.maps.services.Geocoder();
            const places = new kakao.maps.services.Places();

            let marker_list = [];
            let infowindow_list = [];

            const callback = (result, status) => {
                console.log(result[0]);
                if (status === kakao.maps.services.Status.OK) {
                    setCenter(result[0].y, result[0].x);

                    clearMarker();
                    removeMarker();
                    clearInfoWindow();
                    removeInfowindow();

                    const marker = new kakao.maps.Marker({ 
                        position: map.getCenter() 
                    });                    
                    marker_list.push(marker);

                    const infowindow = new kakao.maps.InfoWindow({
                        position : map.getCenter(),
                        content : `<div class="marker-infowindow"><div>${result[0].address_name}</div></div>` 
                    });
                    infowindow_list.push(infowindow);

                    drawMarker();
                    map.setLevel(result[0].address_type === 'REGION' ? 9 : 3);

                    document.querySelector("#address-keyword").focus();
                }
            };

            const callback2 = (result, status) => {
                console.log(result);
                if (status === kakao.maps.services.Status.OK) {
                    setCenter(result[0].y, result[0].x);

                    clearMarker();
                    removeMarker();
                    clearInfoWindow();
                    removeInfowindow();

                    result.forEach((item) => {
                        const markerPos = new kakao.maps.LatLng(item.y, item.x);
                        const marker = new kakao.maps.Marker({ 
                            position: markerPos
                        }); 
                        marker_list.push(marker);
                        
                        const infowindow = new kakao.maps.InfoWindow({
                            position : markerPos, 
                            content : `<div class="marker-infowindow"><div>${item.place_name}</div></div>` 
                        });
                        infowindow_list.push(infowindow);
                    });
                    drawMarker();
                    map.setLevel(5);
                }
            };

            document.querySelector('#address-region').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    const { target : { value }} = e;
                    
                    geocoder.addressSearch(value, callback, {
                        analyze_type: kakao.maps.services.AnalyzeType.SIMILAR,
                    });
                }
            });

            document.querySelector("#address-keyword").addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    const { target : { value }} = e;

                    places.keywordSearch(value, callback2, {
                        location: map.getCenter(),
                        radius: 5000,
                        sort: kakao.maps.services.SortBy.DISTANCE,
                    });
                }
            });

            function clearMarker() {
                marker_list.forEach(marker => {
                    marker.setMap(null);
                });
            }
            function clearInfoWindow() {
                infowindow_list.forEach(infowindow => {
                    infowindow.close();
                });
            }

            function removeMarker() {
                marker_list = [];
            }
            function removeInfowindow() {
                infowindow_list = [];
            }

            function drawMarker() {
                marker_list.forEach((marker, i) => {
                    marker.setMap(map);
                    if(infowindow_list[i]) {
                        infowindow_list[i].open(map, marker);
                    }
                });
            };

            function setCenter(lat, lng) {            
                // 이동할 위도 경도 위치를 생성합니다 
                const centerXY = new kakao.maps.LatLng(lat, lng);
                
                // 지도 중심을 이동 시킵니다
                map.setCenter(centerXY);
            }
        </script>
    </body>
</html>